/*global define*/

define([
    'jquery',    
    'underscore',
    'backbone',
    'libs/backbone/models/system/info/firmware_version',
    'libs/backbone/models/system/fw-update/call-external-api'
], function ($, _, Backbone, FirmwareVer, CallExtUrl) {
    'use strict';
    var FirmwareUpdateModel = Backbone.Model.extend({
        fetch:function(options) {
            //get firmware version
            var firmwareVer = new FirmwareVer();
                firmwareVer.fetch({
                    success:function(){
                        this.set('version', firmwareVer.get('version'));
                        //check any updated firmware for the board
                        var get_firmware_url = 'http://myibox.net/firmware/update_xml.jsp?UserAgent=Syabas/'+this.get('version');
                        //var get_firmware_url = 'http://myibox.net/firmware/update_xml.jsp?UserAgent=Syabas/01-01-150714-02-POP-899-800';

                        var callExtUrl = new CallExtUrl();
                            callExtUrl.fetch(get_firmware_url, {
                                success:function(target, data, sync){
                                    console.log('get firmware success!!!');
                                    var xml =  $($.parseXML(callExtUrl.get('data')));
                                        this.set('updateAvailable', xml.find('updateAvailable').text());
                                        this.set('copyright', xml.find('copyright').text());
                                        this.set('disclaimer', xml.find('text').text());
                                        this.set('changes', xml.find('changes').text());
                                        this.set('releaseDate', xml.find('releaseDate').text());
                                        this.set('latestRelease', xml.find('latestRelease').text());
                                        this.set('url', xml.find('url').text());
                                    if(options.success) options.success(target, data, sync);
                                }.bind(this),
                                error:function(target, data, sync){
                                    console.log('get firmware failed!!!');
                                    if(options.error) options.error(target, data, sync);
                                }.bind(this)
                            })
                    }.bind(this),
                    error:function(target, data, sync){
                        console.log('get firmware version error!!!');
                        if(options.error){options.error(target, data, sync)}
                    }.bind(this)                   
                })
        }
    });

    return FirmwareUpdateModel;

});
