/**
* Copyright 2014-2015 Cloud Media Sdn. Bhd.
*
* This file is part of Xuan Automation Application.
*
* Xuan Automation Application is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* Xuan Automation Application is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with Xuan Automation Application.  If not, see <http://www.gnu.org/licenses/>.
*/
/* !
 * kurobox v.0.0.21
 * (c) 2015 Cloud Media.
 * http://www.cloudmedia.com/
 * 
 * Credit:
 *     eventsource polyfill by Yaffle (https://github.com/Yaffle/EventSource/) */
!function(a){"use strict";function b(){this.data={}}function c(){this.listeners=new b}function d(a){setTimeout(function(){throw a},0)}function e(a){this.type=a,this.target=null}function f(a,b){e.call(this,a),this.data=b.data,this.lastEventId=b.lastEventId}function g(a,b){var c=Number(a)||b;return z>c?z:c>A?A:c}function h(a,b,c){try{"function"==typeof b&&b.call(a,c)}catch(e){d(e)}}function i(b,d){function i(){L=s,null!==H&&(H.abort(),H=null),0!==I&&(clearTimeout(I),I=0),0!==J&&(clearTimeout(J),J=0),E.readyState=s}function j(a){var b=L===r||L===q?H.responseText||"":"",c=null,d=!1;if(L===q){var i=0,j="",k="";if(n)try{i=Number(H.status||0),j=String(H.statusText||""),k=String(H.getResponseHeader("Content-Type")||"")}catch(l){i=0}else i=200,k=H.contentType;if(200===i&&y.test(k)){if(L=r,G=!0,F=B,E.readyState=r,c=new e("open"),E.dispatchEvent(c),h(E,E.onopen,c),L===s)return}else if(0!==i){var m="";m=200!==i?"EventSource's response has a status "+i+" "+j.replace(/\s+/g," ")+" that is not 200. Aborting the connection.":"EventSource's response has a Content-Type specifying an unsupported type: "+k.replace(/\s+/g," ")+". Aborting the connection.",setTimeout(function(){throw new Error(m)}),d=!0}}if(L===r){b.length>K&&(G=!0);for(var o=K-1,z=b.length,J="\n";++o<z;)if(J=b[o],Q===t&&"\n"===J)Q=u;else if(Q===t&&(Q=u),"\r"===J||"\n"===J){if("data"===R?M.push(S):"id"===R?N=S:"event"===R?O=S:"retry"===R?(B=g(S,B),F=B):"heartbeatTimeout"===R&&(C=g(S,C),0!==I&&(clearTimeout(I),I=setTimeout(P,C))),S="",R="",Q===u){if(0!==M.length&&(D=N,""===O&&(O="message"),c=new f(O,{data:M.join("\n"),lastEventId:N}),E.dispatchEvent(c),"message"===O&&h(E,E.onmessage,c),L===s))return;M.length=0,O=""}Q="\r"===J?t:u}else Q===u&&(Q=v),Q===v?":"===J?Q=w:R+=J:Q===w?(" "!==J&&(S+=J),Q=x):Q===x&&(S+=J);K=z}L!==r&&L!==q||!(a||d||K>1048576||0===I&&!G)?0===I&&(G=!1,I=setTimeout(P,C)):(L=p,H.abort(),0!==I&&(clearTimeout(I),I=0),F>16*B&&(F=16*B),F>A&&(F=A),I=setTimeout(P,F),F=2*F+1,E.readyState=q,c=new e("error"),E.dispatchEvent(c),h(E,E.onerror,c))}function k(){j(!1)}function l(){j(!0)}b=String(b);var z=Boolean(m&&d&&d.withCredentials),B=g(d?d.retry:0/0,1e3),C=g(d?d.heartbeatTimeout:0/0,45e3),D=d&&d.lastEventId&&String(d.lastEventId)||"",E=this,F=B,G=!1,H=new o,I=0,J=0,K=0,L=p,M=[],N="",O="",P=null,Q=u,R="",S="";d=null,n&&(J=setTimeout(function T(){3===H.readyState&&k(),J=setTimeout(T,500)},0)),P=function(){if(I=0,L!==p)return void j(!1);if(n&&(void 0!==H.sendAsBinary||void 0===H.onloadend)&&a.document&&a.document.readyState&&"complete"!==a.document.readyState)return void(I=setTimeout(P,4));H.onload=H.onerror=l,n&&(H.onabort=l,H.onreadystatechange=k),H.onprogress=k,G=!1,I=setTimeout(P,C),K=0,L=q,M.length=0,O="",N=D,S="",R="",Q=u;var c=b.slice(0,5);c="data:"!==c&&"blob:"!==c?b+((-1===b.indexOf("?",0)?"?":"&")+"lastEventId="+encodeURIComponent(D)+"&r="+String(Math.random()+1).slice(2)):b,H.open("GET",c,!0),n&&(H.withCredentials=z,H.responseType="text",H.setRequestHeader("Accept","text/event-stream")),H.send(null)},c.call(this),this.close=i,this.url=b,this.readyState=q,this.withCredentials=z,this.onopen=null,this.onmessage=null,this.onerror=null,P()}function j(){this.CONNECTING=q,this.OPEN=r,this.CLOSED=s}b.prototype={get:function(a){return this.data[a+"~"]},set:function(a,b){this.data[a+"~"]=b},"delete":function(a){delete this.data[a+"~"]}},c.prototype={dispatchEvent:function(a){a.target=this;var b=String(a.type),c=this.listeners,e=c.get(b);if(e)for(var f=e.length,g=-1,h=null;++g<f;){h=e[g];try{h.call(this,a)}catch(i){d(i)}}},addEventListener:function(a,b){a=String(a);var c=this.listeners,d=c.get(a);d||(d=[],c.set(a,d));for(var e=d.length;--e>=0;)if(d[e]===b)return;d.push(b)},removeEventListener:function(a,b){a=String(a);var c=this.listeners,d=c.get(a);if(d){for(var e=d.length,f=[],g=-1;++g<e;)d[g]!==b&&f.push(d[g]);0===f.length?c["delete"](a):c.set(a,f)}}},f.prototype=e.prototype;var k=a.XMLHttpRequest,l=a.XDomainRequest,m=Boolean(k&&void 0!==(new k).withCredentials),n=m,o=m?k:l,p=-1,q=0,r=1,s=2,t=3,u=4,v=5,w=6,x=7,y=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i,z=1e3,A=18e6;j.prototype=c.prototype,i.prototype=new j,j.call(i),o&&(a.NativeEventSource=a.EventSource,a.EventSource=i)}(this),function(a,b){if("function"==typeof define&&define.amd)define(["exports","jquery","underscore"],function(c,d,e){a.Kurobox=b(a,c,d,e)});else if("object"==typeof exports){var c=require("jquery"),d=require("underscore");a.Kurobox=b(a,exports,c,d)}else{var e=function(){};a.Kurobox=b(a,e,a.$,a._)}}(this,function(a,b,c,d){"use strict";var e="/cgi-bin/syb_reqresp_cgi",f="/cgi-bin/syb_event_cgi",g="450",h="10443",i="tunnel.thexuan.com",j=function(){return void 0!==b.redirectUrlAfterLogin?"/system/?callback="+encodeURIComponent(b.redirectUrlAfterLogin):"/system/?callback="+encodeURIComponent(a.location)},k=function(a,b){for(var c in b)void 0===a[c]&&(a[c]=b[c]);return a};b.host="",b.global_api_error_handler=void 0,b.redirectLogin=!0,b.redirectUrlAfterLogin=void 0;var l=function(a){var b=d.indexOf([403,401,405],a);return b>=0},m=function(c,d){var e=function(){l(c.error.code)&&d.redirectLogin===!0?a.location=j():d.error&&d.error(c)};void 0===b.global_api_error_handler||d.skipGlobalError?e():b.global_api_error_handler(c,e)},n=function(){return window.location.hostname.indexOf(i)>=0},o=function(a){return delete a.method,delete a.module,delete a.func,a};b.api=function(a,d,f){var g={redirectLogin:b.redirectLogin,url:b.host+e,httpMethod:"GET"};f=k(f,g);var d=d||{},h={},i={};if(void 0!==b.app_id||void 0!==f.app_id&&void 0==d.app_id?(i.app_id=b.app_id||f.app_id,i.method=a,d.module&&(i.module=d.module)):i.func=a,c.extend(h,d),h=o(h),"POST"===f.httpMethod&&void 0!=f.query_param){var j=o(f.query_param);c.extend(i,j)}return f.url+="?"+c.param(i),c.ajax({type:f.httpMethod,timeout:f.timeout||6e4,url:f.url,data:h,dataType:"json",success:function(a,b,c){if(100===a.theKuroBox.returnValue)f.success&&f.success({response:a.theKuroBox.response,error:{code:a.theKuroBox.returnValue,message:a.theKuroBox.returnMessage},ajax:{data:a,textStatus:b,jqXHR:c}});else{var d={error:{code:a.theKuroBox.returnValue,message:a.theKuroBox.returnMessage},ajax:{data:a,textStatus:b,jqXHR:c}};m(d,f)}},error:function(a,b,c){var d={error:{code:-1,message:c||b},ajax:{textStatus:b,jqXHR:a,httpError:c}};m(d,f)}})},b["native"]=function(a,b,d,e){var f=function(){b&&b.apply(this,c.isArray(e)?e:[e])}.bind(this);if("undefined"!=typeof NativeMethod){var g=[];return"string"==typeof d?g.push(d):g=g.concat(d),b&&g.push(b),void 0===NativeMethod[a]?void f():NativeMethod[a].apply(this,g)}f()};var p,q,r=function(){this.initialize.apply(this,arguments)},s="__evt__",t=!1,u=function(a,b,c){var e=!1;return d.each(a,function(a){return a.callback===b&&a.context===c?(e=!0,!1):void 0}),e},v=function(){var a=window.location.hostname.split(".");return a.splice(1,0,"event"),a=a.join(".")};return d.extend(r.prototype,{verbose:!1,connected:!1,_events:{},port:g,retry:-1,retryDelay:3e3,_retryCount:0,_create_eventsource_tunnel:function(){var a;a=n()?[v(),h]:[window.location.hostname,g],b["native"]("bypassIPAndPort",null,a)},initialize:function(){q=this._onSocketEvent.bind(this)},on:function(a,b,c){c=c||this,a=s+a;var d=!1;if(void 0===this._events[a]&&(this._events[a]=[],a.match("socket:")&&(d=!0)),u(this._events[a],b,c)?this.verbose:this._events[a].push({name:a,callback:b,context:c}),d){var e=a.replace(s+"socket:","");this._addSocketEvent(e)}},off:function(a,b,c){var e=function(a){if(void 0!==this._es&&a.indexOf("socket:")>=0){var b=a.replace(s+"socket:","");this.verbose,this._es.removeEventListener(b,q,!1)}}.bind(this),f=function(a){e(a),this._events[a]=void 0,delete this._events[a]}.bind(this);void 0!==a&&(a=s+a),void 0===a?(d.each(this._events,function(a){d.each(a,function(a){e(a.name)})}),this._events={}):void 0!==this._events[a]&&(void 0===b?f(a):d.each(this._events[a],function(d,e){return d.callback===b&&d.context===c?(this._events[a].splice(e,1),0===this._events[a].length&&f(a),!1):void 0}.bind(this)))},trigger:function(a){a=s+a;var b=this._events[a],c=Array.prototype.slice.call(arguments,1);b&&d.each(b,function(a){a.callback.apply(a.context,c)}.bind(this))},start:function(a){if("undefined"==typeof EventSource)throw"EventSource support is not available in this browser!";if(void 0===this._es){void 0==a&&(a=!0),a===!0&&(this._retryCount=0);var c,e="";""===b.host?(c=window.location.protocol+"//"+window.location.hostname,n()?(c=window.location.protocol+"//"+v(),e=":"+h):e=":"+g):(c=b.host,e=":"+g),this.url=c,this.url+=e,this.url+=f+"?app_id="+b.app_id,this.verbose,this._es=new EventSource(this.url),this._es.addEventListener("open",this._onEsInit.bind(this),!1),this._es.addEventListener("error",this._onEsError.bind(this),!1),this._es.addEventListener("ping",this._onEsPing.bind(this),!1),this._es.addEventListener("socket-error",this._onEsSocketError.bind(this),!1),void 0!==p&&(d.each(p,function(a){this._addSocketEvent(a)}.bind(this)),p=void 0),this.connected=!1}},stop:function(){void 0!==this._es&&(this.off(),this._reset(),this.verbose,this.trigger("close"))},_reset:function(){this._es.removeEventListener("open",this._onEsInit.bind(this),!1),this._es.removeEventListener("error",this._onEsError.bind(this),!1),this._es.removeEventListener("ping",this._onEsPing.bind(this),!1),this._es.removeEventListener("socket-error",this._onEsSocketError.bind(this),!1),this._es.close(),this._es=void 0,this.connected=!1},_onEsError:function(a){this.verbose,this.trigger("error"),this._onEsReconnect()},_onEsSocketError:function(a){this.verbose,this.trigger("error",a.data),this._onEsReconnect()},_onEsReconnect:function(){this._es.close();var a=function(){setTimeout(function(){if(this.trigger("reconnect"),this._reset(),this.verbose){"("+(-1==this.retry?"forever":this._retryCount+1+"/"+this.retry)+")"}this.start(!1),this._retryCount+=1}.bind(this),this.retryDelay)}.bind(this);-1==this.retry?a():this.retry>0&&this._retryCount<this.retry?a():this._retryCount==this.retry&&(this.verbose,this._reset(),this.trigger("reconnect_fail"))},_onEsInit:function(){this.verbose,this._retryCount=0,this.connected=!1},_onEsPing:function(){this.connected||(this.connected=!0,this.trigger("connected")),this.verbose&&(t=!t)},_onSocketEvent:function(a){this.verbose;var b="socket:"+a.type;try{this.trigger(b,JSON.parse(a.data))}catch(a){}},_addSocketEvent:function(a){void 0!==this._es?(this.verbose,this._es.addEventListener(a,q,!1)):(void 0===p&&(p=[]),p.push(a))}}),b.socket=new r,b});